<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova — Sign In</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:      #0d0f14;
            --surface: #151820;
            --s2:      #1c2030;
            --border:  #252a38;
            --accent:  #4f8eff;
            --success: #34d399;
            --danger:  #f87171;
            --text:    #e8eaf0;
            --muted:   #6b7280;
            --r:       12px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'DM Sans',sans-serif;
            background:var(--bg); color:var(--text);
            min-height:100vh; display:flex; align-items:center; justify-content:center;
        }
        body::before {
            content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
            background:
                radial-gradient(ellipse 60% 40% at 20% 10%, rgba(79,142,255,.09) 0%, transparent 60%),
                radial-gradient(ellipse 40% 50% at 80% 80%, rgba(124,92,252,.07) 0%, transparent 60%);
        }
        .wrap { position:relative; z-index:1; width:100%; max-width:420px; padding:24px; }

        /* brand */
        .brand { display:flex; align-items:center; gap:10px; margin-bottom:36px; justify-content:center; }
        .dot { width:10px; height:10px; border-radius:50%; background:var(--accent);
               box-shadow:0 0 14px var(--accent); animation:pulse 2.4s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }
        .brand-name { font-size:22px; font-weight:600; letter-spacing:-.3px; }

        /* card */
        .card {
            background:var(--surface); border:1px solid var(--border);
            border-radius:20px; padding:40px;
            box-shadow:0 24px 80px rgba(0,0,0,.55);
        }
        .card-title   { font-size:24px; font-weight:600; letter-spacing:-.4px; margin-bottom:6px; }
        .card-sub     { font-size:14px; color:var(--muted); margin-bottom:28px; }

        /* field */
        .field { margin-bottom:18px; }
        .field label { display:block; font-size:13px; font-weight:500; color:var(--muted); margin-bottom:8px; }
        .field input {
            width:100%; padding:13px 16px; background:var(--s2); border:1px solid var(--border);
            border-radius:var(--r); color:var(--text); font-family:inherit; font-size:15px;
            transition:border-color .2s, box-shadow .2s;
        }
        .field input::placeholder { color:#3a4055; }
        .field input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,142,255,.15); }

        /* button */
        .btn {
            width:100%; padding:14px; border:none; border-radius:var(--r);
            font-family:inherit; font-size:15px; font-weight:600; cursor:pointer;
            transition:all .2s; margin-top:8px;
        }
        .btn-primary { background:var(--accent); color:#fff; box-shadow:0 4px 20px rgba(79,142,255,.3); }
        .btn-primary:hover { background:#3a7aee; transform:translateY(-1px); box-shadow:0 8px 24px rgba(79,142,255,.4); }
        .btn-primary:disabled { opacity:.6; cursor:not-allowed; transform:none; }
        .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); margin-top:10px; }
        .btn-ghost:hover { border-color:var(--accent); color:var(--text); }

        /* alert */
        .alert { display:none; padding:12px 16px; border-radius:var(--r); font-size:13px; margin-top:16px; }
        .alert.error   { display:block; background:rgba(248,113,113,.12); border:1px solid rgba(248,113,113,.3); color:#fca5a5; }
        .alert.success { display:block; background:rgba(52,211,153,.12);  border:1px solid rgba(52,211,153,.3);  color:#6ee7b7; }

        /* spinner */
        .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(255,255,255,.3);
                   border-top-color:#fff; border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; margin-right:6px; }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* token debug panel */
        .debug-box {
            margin-top:20px; padding:14px; background:var(--s2); border:1px solid var(--border);
            border-radius:var(--r); display:none;
        }
        .debug-box.show { display:block; }
        .debug-label { font-size:11px; font-weight:600; letter-spacing:.8px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
        .debug-token {
            font-family:'DM Mono',monospace; font-size:11px; color:var(--success);
            word-break:break-all; line-height:1.6; max-height:80px; overflow-y:auto;
        }

        .divider { display:flex; align-items:center; gap:12px; color:var(--muted); font-size:12px; margin:20px 0; }
        .divider::before,.divider::after { content:''; flex:1; height:1px; background:var(--border); }
    </style>
</head>
<body>
<div class="wrap">
    <div class="brand"><div class="dot"></div><span class="brand-name">Nova</span></div>

    <div class="card">
        <h1 class="card-title">Sign in</h1>
        <p class="card-sub">Sign in to create or join meetings</p>

        <div class="field">
            <label>Email</label>
            <input type="email" id="email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field">
            <label>Password</label>
            <input type="password" id="password" placeholder="Your password" autocomplete="current-password">
        </div>

        <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">Sign In</button>

        <div class="divider">or continue without account</div>

        <button class="btn btn-ghost" onclick="location.href='nova-join.html'">Join as Guest →</button>

        <div class="alert" id="alert"></div>

        <!-- Token debug — visible after login so you can confirm it's received -->
        <div class="debug-box" id="debugBox">
            <div class="debug-label">✓ Token received (session saved)</div>
            <div class="debug-token" id="debugToken"></div>
        </div>
    </div>
</div>

<script src="novaState.js"></script>
<script>
    const API = 'https://poikiloblastic-leeanne-gazeless.ngrok-free.dev/api';

    // If already logged in, skip straight to dashboard
    if (NovaState.isLoggedIn()) location.href = 'novaDash.html';

    document.getElementById('password').addEventListener('keypress', e => {
        if (e.key === 'Enter') doLogin();
    });

    function showAlert(msg, type = 'error') {
        const el = document.getElementById('alert');
        el.textContent = msg;
        el.className = `alert ${type}`;
    }

    async function doLogin() {
        const email    = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!email || !password) { showAlert('Please enter your email and password'); return; }

        const btn = document.getElementById('loginBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Signing in…';

        try {
            const res = await fetch(`${API}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            // Always try to parse as JSON first
            let data;
            const text = await res.text();
            try { data = JSON.parse(text); }
            catch {
                showAlert(`Server returned non-JSON (HTTP ${res.status}). Check server logs.`);
                btn.disabled = false; btn.textContent = 'Sign In';
                return;
            }

            console.log('Login raw response:', data);

            // ── Your API returns: { accessToken, refreshToken, message }
            // It does NOT have a success field — treat any 2xx as success,
            // and any non-2xx or missing accessToken as failure.
            if (!res.ok) {
                showAlert(data.message || data.error || `Login failed (HTTP ${res.status})`);
                btn.disabled = false; btn.textContent = 'Sign In';
                return;
            }

            // ── Extract token from YOUR exact response shape ───────────────
            // { "accessToken": "eyJ...", "refreshToken": "...", "message": "Login successful" }
            const token = data?.accessToken || null;

            if (!token) {
                console.error('No accessToken in response:', JSON.stringify(data, null, 2));
                showAlert('Login succeeded but no accessToken returned. See console.');
                btn.disabled = false; btn.textContent = 'Sign In';
                return;
            }

            // Extract user info — decode JWT sub (email) as fallback
            let nameFromJwt = email.split('@')[0];
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('JWT payload:', payload);
                // sub is the email in your JWT
                nameFromJwt = payload?.name || payload?.firstName || payload?.sub?.split('@')[0] || nameFromJwt;
            } catch(e) {}

            const user = {
                name:   nameFromJwt,
                email:  email,
                id:     null, // not returned at login — fetched if needed later
            };

            // ── Persist to sessionStorage via helper ───────────────────────
            NovaState.saveLoginResponse(data, email);
            const userDetails = NovaState.getUser(); // re-read what was saved

            // Show token in debug panel briefly
            document.getElementById('debugToken').textContent = token;
            document.getElementById('debugBox').classList.add('show');
            showAlert(`Welcome back, ${userDetails.name}! Redirecting…`, 'success');
            btn.innerHTML = '✓ Signed in';

            // Redirect to dashboard after short delay
            setTimeout(() => location.href = 'novaDash.html', 1200);

        } catch (err) {
            console.error('Login fetch error:', err);
            showAlert('Cannot reach server. Is it running on localhost:8080?');
            btn.disabled = false;
            btn.textContent = 'Sign In';
        }
    }
</script>
</body>
</html>