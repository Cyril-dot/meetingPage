<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Meeting - Complete</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1F2937;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            color: #4F46E5;
        }

        .status {
            font-size: 12px;
            padding: 6px 12px;
            background: #10B981;
            color: white;
            border-radius: 20px;
            font-weight: 600;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            padding: 32px 24px;
            max-width: 500px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-box h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #4F46E5;
        }

        .login-box p {
            color: #6B7280;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4F46E5;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: #F3F4F6;
            padding: 4px;
            border-radius: 8px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: #4F46E5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        .alert.success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        .video-container {
            display: none;
            background: #0F172A;
            border-radius: 16px;
            overflow: hidden;
            margin-top: 16px;
            height: calc(100vh - 200px);
            min-height: 500px;
        }

        .video-container.active {
            display: flex;
            flex-direction: column;
        }

        /* NEW: Main content area - splits into presentation and participants */
        .video-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            overflow: hidden;
        }

        /* NEW: Screen share main stage */
        .screen-share-stage {
            display: none;
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        .screen-share-stage.active {
            display: block;
        }

        .screen-share-stage video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* NEW: Picture-in-Picture presenter overlay */
        .pip-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 240px;
            height: 180px;
            background: #1E293B;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border: 3px solid rgba(255,255,255,0.1);
            z-index: 10;
        }

        .pip-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pip-overlay .video-avatar {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }

        .pip-overlay .video-overlay {
            padding: 8px;
        }

        .pip-overlay .video-name {
            font-size: 12px;
        }

        .pip-overlay .video-status i {
            font-size: 12px;
        }

        /* Modified: Participants strip below screen share */
        .participants-strip {
            display: none;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            height: 140px;
        }

        .participants-strip.active {
            display: flex;
        }

        .participants-strip .video-tile {
            min-width: 180px;
            max-width: 180px;
            height: 130px;
            flex-shrink: 0;
        }

        .participants-strip .video-avatar {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .participants-strip .video-overlay {
            padding: 8px;
        }

        .participants-strip .video-name {
            font-size: 11px;
        }

        .participants-strip .video-status i {
            font-size: 11px;
        }

        /* Original grid - shows when no screen share */
        #video-grid {
            flex: 1;
            display: grid;
            gap: 8px;
            overflow-y: auto;
            background: #1E293B;
            min-height: 0;
        }

        #video-grid.participants-1 {
            grid-template-columns: 1fr;
        }

        #video-grid.participants-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        #video-grid.participants-3,
        #video-grid.participants-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        #video-grid.participants-5,
        #video-grid.participants-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        #video-grid.participants-7,
        #video-grid.participants-8,
        #video-grid.participants-9 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .video-tile {
            position: relative;
            background: #1E293B;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .video-tile video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .video-tile audio {
            display: none;
        }

        .video-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 700;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-name {
            font-size: 14px;
            font-weight: 600;
        }

        .video-status {
            display: flex;
            gap: 8px;
        }

        .video-status i {
            font-size: 14px;
        }

        .screen-share-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #EF4444;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 5;
        }

        /* ENHANCED: More realistic reactions */
        .reaction-overlay {
            position: absolute;
            font-size: 80px;
            pointer-events: none;
            z-index: 15;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }

        .reaction-float {
            animation: reactionFloat 3s ease-out forwards;
        }

        .reaction-burst {
            animation: reactionBurst 2s ease-out forwards;
        }

        .reaction-bounce {
            animation: reactionBounce 2.5s ease-out forwards;
        }

        .reaction-spin {
            animation: reactionSpin 2s ease-out forwards;
        }

        @keyframes reactionFloat {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                transform: translate(-50%, -50%) scale(1.3) rotate(10deg);
                opacity: 1;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.1) rotate(-5deg);
            }
            100% {
                transform: translate(-50%, -150%) scale(1) rotate(0deg);
                opacity: 0;
            }
        }

        @keyframes reactionBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            15% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 1;
            }
            30% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }

        @keyframes reactionBounce {
            0% {
                transform: translate(-50%, -200%) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            25% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            40% {
                transform: translate(-50%, -80%) scale(1);
            }
            55% {
                transform: translate(-50%, -60%) scale(1.1);
            }
            70% {
                transform: translate(-50%, -70%) scale(1);
            }
            85% {
                transform: translate(-50%, -65%) scale(1.05);
            }
            100% {
                transform: translate(-50%, -70%) scale(1);
                opacity: 0;
            }
        }

        @keyframes reactionSpin {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }
            15% {
                transform: translate(-50%, -50%) scale(1.3) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1) rotate(720deg);
                opacity: 0;
            }
        }

        .controls {
            background: #0F172A;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            border-top: 1px solid #334155;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .control-btn:active {
            transform: scale(0.9);
        }

        .control-btn.active {
            background: #EF4444;
        }

        .control-btn.leave {
            background: #EF4444;
        }

        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 280px;
        }

        .emoji-picker.active {
            display: flex;
        }

        .emoji-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: transparent;
            font-size: 28px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .emoji-btn:hover {
            background: #F3F4F6;
            transform: scale(1.1);
        }

        .meeting-info {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .meeting-info.active {
            display: block;
        }

        .meeting-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #4F46E5;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #F9FAFB;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .info-row strong {
            font-size: 13px;
            color: #374151;
        }

        .info-row span {
            font-size: 12px;
            color: #6B7280;
            font-family: monospace;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .video-content {
                padding: 8px;
            }

            .pip-overlay {
                width: 160px;
                height: 120px;
                top: 8px;
                right: 8px;
            }

            .participants-strip {
                height: 100px;
            }

            .participants-strip .video-tile {
                min-width: 140px;
                max-width: 140px;
                height: 95px;
            }

            #video-grid {
                gap: 6px;
            }

            #video-grid.participants-3,
            #video-grid.participants-4,
            #video-grid.participants-5,
            #video-grid.participants-6 {
                grid-template-columns: repeat(2, 1fr);
            }

            .video-tile {
                min-height: 150px;
            }

            .video-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .controls {
                gap: 8px;
            }

            .reaction-overlay {
                font-size: 60px;
            }
        }

        @media (min-width: 769px) {
            .header h1 {
                font-size: 24px;
            }

            .status {
                font-size: 14px;
            }

            .login-box {
                padding: 48px;
            }

            .login-box h2 {
                font-size: 32px;
            }

            .video-container {
                height: calc(100vh - 180px);
            }

            .video-tile {
                min-height: 250px;
            }

            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé• Video Meeting</h1>
        <div class="status" id="status">Ready</div>
    </div>

    <div class="container">
        <div class="login-box" id="loginBox">
            <h2>Join Meeting</h2>
            <p>Create or join a video meeting</p>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('create')">Create</button>
                <button class="tab" onclick="switchTab('join')">Join</button>
            </div>

            <div class="alert error" id="errorAlert"></div>
            <div class="alert success" id="successAlert"></div>

            <div class="input-group">
                <label>JWT Token</label>
                <input type="password" id="jwtToken" placeholder="Enter your JWT token">
            </div>

            <div class="tab-content active" id="createTab">
                <div class="input-group">
                    <label>Meeting Title</label>
                    <input type="text" id="meetingTitle" value="My Meeting">
                </div>
                <button class="btn" onclick="createMeeting()">Create & Join</button>
            </div>

            <div class="tab-content" id="joinTab">
                <div class="input-group">
                    <label>Meeting ID</label>
                    <input type="number" id="meetingId" placeholder="Enter meeting ID">
                </div>
                <button class="btn" onclick="joinMeeting()">Join Meeting</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Connecting...</p>
        </div>

        <div class="meeting-info" id="meetingInfo">
            <h3>Meeting Information</h3>
            <div class="info-row">
                <strong>Meeting ID:</strong>
                <div>
                    <span id="displayMeetingId">-</span>
                    <button class="copy-btn" onclick="copyText('displayMeetingId')">Copy</button>
                </div>
            </div>
            <div class="info-row">
                <strong>Share Link:</strong>
                <div>
                    <span id="displayLink" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">-</span>
                    <button class="copy-btn" onclick="copyText('displayLink')">Copy</button>
                </div>
            </div>
        </div>

        <div class="video-container" id="videoContainer">
            <div class="video-content">
                <!-- Screen share main stage -->
                <div class="screen-share-stage" id="screenStage">
                    <!-- Screen share video will be added here -->
                    <!-- Presenter's face will be in PIP overlay -->
                </div>

                <!-- Participants strip (shown when screen sharing) -->
                <div class="participants-strip" id="participantsStrip">
                    <!-- Other participants shown here during screen share -->
                </div>

                <!-- Regular grid (shown when no screen share) -->
                <div id="video-grid" class="participants-1"></div>
            </div>
            
            <div class="emoji-picker" id="emojiPicker">
                <button class="emoji-btn" onclick="sendReaction('üëç')">üëç</button>
                <button class="emoji-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="emoji-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                <button class="emoji-btn" onclick="sendReaction('üòÆ')">üòÆ</button>
                <button class="emoji-btn" onclick="sendReaction('üëè')">üëè</button>
                <button class="emoji-btn" onclick="sendReaction('üéâ')">üéâ</button>
                <button class="emoji-btn" onclick="sendReaction('üî•')">üî•</button>
                <button class="emoji-btn" onclick="sendReaction('‚ú®')">‚ú®</button>
            </div>

            <div class="controls">
                <button class="control-btn" id="muteBtn" onclick="toggleMute()" title="Mute">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="control-btn" id="videoBtn" onclick="toggleVideo()" title="Video">
                    <i class="fas fa-video"></i>
                </button>
                <button class="control-btn" id="screenBtn" onclick="toggleScreenShare()" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="control-btn" id="emojiBtn" onclick="toggleEmojiPicker()" title="Reactions">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="control-btn leave" onclick="leaveMeeting()" title="Leave">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { StreamVideoClient } from 'https://esm.sh/@stream-io/video-client@1.9.1';
        window.StreamVideoClient = StreamVideoClient;
        window.sdkLoaded = true;
        console.log('‚úÖ SDK Loaded');
    </script>

    <script>
        const API_URL = 'https://poikiloblastic-leeanne-gazeless.ngrok-free.dev';
        
        let client = null;
        let call = null;
        let localStream = null;
        let isMuted = false;
        let isVideoOff = false;
        let isScreenSharing = false;

        function log(msg, data = null) {
            console.log(`[APP] ${msg}`, data || '');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'create') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('createTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('joinTab').classList.add('active');
            }
        }

        async function createMeeting() {
            const token = document.getElementById('jwtToken').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();

            if (!token) {
                showError('Please enter JWT token');
                return;
            }

            showLoading(true);
            log('Creating meeting...');

            try {
                const res = await fetch(`${API_URL}/api/meetings/instant`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        title: title,
                        waitingRoomEnabled: false,
                        recordingEnabled: false
                    })
                });

                if (!res.ok) throw new Error('Failed to create meeting');

                const data = await res.json();
                log('Meeting created', data);

                await initCall(data.callCredentials, data.meetingId);

            } catch (err) {
                log('Error creating meeting', err);
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        async function joinMeeting() {
            const token = document.getElementById('jwtToken').value.trim();
            const meetingId = document.getElementById('meetingId').value.trim();

            if (!token || !meetingId) {
                showError('Please enter JWT token and Meeting ID');
                return;
            }

            showLoading(true);
            log('Joining meeting...');

            try {
                const res = await fetch(`${API_URL}/api/meetings/${meetingId}/join`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!res.ok) throw new Error('Failed to join meeting');

                const data = await res.json();
                log('Joined meeting', data);

                await initCall(data.callCredentials, meetingId);

            } catch (err) {
                log('Error joining meeting', err);
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        async function initCall(credentials, meetingId) {
            try {
                await new Promise(resolve => {
                    if (window.sdkLoaded) resolve();
                    else setTimeout(resolve, 2000);
                });

                if (!window.StreamVideoClient) {
                    throw new Error('SDK not loaded');
                }

                log('Getting local media...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000
                    }
                });

                log('‚úÖ Local media obtained');

                const { apiKey, userId, userName, token, callId } = credentials;
                
                log('Creating client...');
                client = new window.StreamVideoClient({
                    apiKey: apiKey,
                    user: { id: userId, name: userName || 'User' },
                    token: token
                });

                log('Creating call...');
                call = client.call('default', callId);

                log('Joining call...');
                await call.join({ create: true });
                
                log('‚úÖ Joined call');

                log('Enabling camera...');
                await call.camera.enable();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('Enabling microphone...');
                await call.microphone.enable();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('‚úÖ Media enabled');

                setupEventListeners();

                await new Promise(resolve => setTimeout(resolve, 3000));

                renderAllParticipants();

                showVideoUI(meetingId);

            } catch (err) {
                log('Init failed', err);
                showError('Failed to initialize: ' + err.message);
                throw err;
            }
        }

        function setupEventListeners() {
            log('Setting up listeners...');

            call.state.participants$.subscribe((participantList) => {
                log('üìä Participants changed', { count: participantList.length });
                setTimeout(() => renderAllParticipants(), 1000);
            });

            call.on('track.published', (event) => {
                log('üìπ Track published', event);
                setTimeout(() => renderAllParticipants(), 1000);
            });

            call.on('track.unpublished', (event) => {
                log('Track unpublished', event);
                setTimeout(() => renderAllParticipants(), 500);
            });

            call.on('participant.joined', (event) => {
                log('‚úÖ Participant joined', event.participant?.name);
                setTimeout(() => renderAllParticipants(), 2000);
            });

            call.on('participant.left', (event) => {
                log('‚ùå Participant left', event.participant?.name);
                renderAllParticipants();
            });

            call.on('custom', (event) => {
                if (event.type === 'reaction') {
                    log('üòä Reaction received', event);
                    showReaction(event.user.id, event.custom.emoji);
                }
            });

            log('‚úÖ Event listeners setup');
        }

        function renderAllParticipants() {
            if (!call) return;

            const participantList = Array.from(call.state.participants.values());
            
            log('üé® Rendering participants', { count: participantList.length });

            // Check if anyone is screen sharing
            const screenSharers = participantList.filter(p => {
                const stream = p.screenShareStream;
                return stream && 
                       stream.getVideoTracks().length > 0 &&
                       stream.getVideoTracks()[0].enabled &&
                       stream.getVideoTracks()[0].readyState === 'live';
            });

            const isAnyoneScreenSharing = screenSharers.length > 0;

            if (isAnyoneScreenSharing) {
                renderScreenShareLayout(participantList, screenSharers[0]);
            } else {
                renderGridLayout(participantList);
            }
        }

        function renderScreenShareLayout(participantList, screenSharer) {
            log('üñ•Ô∏è Rendering screen share layout');

            const stage = document.getElementById('screenStage');
            const strip = document.getElementById('participantsStrip');
            const grid = document.getElementById('video-grid');

            // Show screen share layout
            stage.classList.add('active');
            strip.classList.add('active');
            grid.style.display = 'none';

            // Clear previous content
            stage.innerHTML = '';
            strip.innerHTML = '';

            // Add screen share to stage
            const screenStream = screenSharer.screenShareStream;
            const screenVideo = document.createElement('video');
            screenVideo.autoplay = true;
            screenVideo.playsInline = true;
            screenVideo.muted = true;
            screenVideo.srcObject = screenStream;
            screenVideo.style.objectFit = 'contain';
            stage.appendChild(screenVideo);

            screenVideo.play().catch(err => log('Screen play failed', err));

            // Add badge
            const badge = document.createElement('div');
            badge.className = 'screen-share-badge';
            badge.innerHTML = `<i class="fas fa-desktop"></i> ${screenSharer.name || 'User'} is presenting`;
            stage.appendChild(badge);

            // Add presenter's video as PIP overlay
            const presenterVideo = screenSharer.videoStream;
            const hasPresenterVideo = presenterVideo && 
                                     presenterVideo.getVideoTracks().length > 0 &&
                                     presenterVideo.getVideoTracks()[0].enabled &&
                                     presenterVideo.getVideoTracks()[0].readyState === 'live';

            if (hasPresenterVideo) {
                const pip = document.createElement('div');
                pip.className = 'pip-overlay';

                const pipVideo = document.createElement('video');
                pipVideo.autoplay = true;
                pipVideo.playsInline = true;
                pipVideo.muted = screenSharer.isLocalParticipant;
                pipVideo.srcObject = presenterVideo;
                pip.appendChild(pipVideo);

                pipVideo.play().catch(err => log('PIP video failed', err));

                // Add overlay
                const overlay = document.createElement('div');
                overlay.className = 'video-overlay';
                overlay.innerHTML = `<div class="video-name">${screenSharer.name || 'User'}</div>`;
                pip.appendChild(overlay);

                stage.appendChild(pip);
            } else {
                // Show avatar in PIP
                const pip = document.createElement('div');
                pip.className = 'pip-overlay';

                const avatar = document.createElement('div');
                avatar.className = 'video-avatar';
                const initial = (screenSharer.name || 'U').charAt(0).toUpperCase();
                avatar.textContent = initial;
                pip.appendChild(avatar);

                const overlay = document.createElement('div');
                overlay.className = 'video-overlay';
                overlay.innerHTML = `<div class="video-name">${screenSharer.name || 'User'}</div>`;
                pip.appendChild(overlay);

                stage.appendChild(pip);
            }

            // Add all other participants to strip
            participantList.forEach(participant => {
                // Skip screen sharer's screen share tile
                if (participant.userId === screenSharer.userId) {
                    return; // Already in PIP
                }

                const tile = createStripTile(participant);
                strip.appendChild(tile);
            });

            log('‚úÖ Screen share layout rendered');
        }

        function renderGridLayout(participantList) {
            log('üé® Rendering grid layout');

            const stage = document.getElementById('screenStage');
            const strip = document.getElementById('participantsStrip');
            const grid = document.getElementById('video-grid');

            // Show grid layout
            stage.classList.remove('active');
            strip.classList.remove('active');
            grid.style.display = 'grid';

            // Clear grid
            grid.innerHTML = '';

            // Update grid class
            grid.className = `participants-${Math.min(participantList.length, 9)}`;

            // Render each participant
            participantList.forEach(participant => {
                const tile = createParticipantTile(participant);
                grid.appendChild(tile);
            });

            log(`‚úÖ Grid rendered with ${participantList.length} participants`);
        }

        function createStripTile(participant) {
            const tile = document.createElement('div');
            tile.className = 'video-tile';
            tile.id = `strip-tile-${participant.userId}`;

            const name = participant.name || participant.userId || 'Guest';
            const initial = name.charAt(0).toUpperCase();
            const isLocal = participant.isLocalParticipant;

            const videoStream = participant.videoStream;
            const hasVideo = videoStream && 
                            videoStream.getVideoTracks().length > 0 &&
                            videoStream.getVideoTracks()[0].enabled &&
                            videoStream.getVideoTracks()[0].readyState === 'live';

            const audioStream = participant.audioStream;
            const hasAudio = audioStream && 
                            audioStream.getAudioTracks().length > 0 &&
                            audioStream.getAudioTracks()[0].enabled &&
                            audioStream.getAudioTracks()[0].readyState === 'live';

            if (hasVideo) {
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.muted = isLocal;
                video.srcObject = videoStream;
                tile.appendChild(video);

                video.onloadedmetadata = () => {
                    video.play().catch(err => setTimeout(() => video.play(), 500));
                };
            } else {
                const avatar = document.createElement('div');
                avatar.className = 'video-avatar';
                avatar.textContent = initial;
                tile.appendChild(avatar);
            }

            if (hasAudio && !isLocal) {
                const audio = document.createElement('audio');
                audio.autoplay = true;
                audio.srcObject = audioStream;
                tile.appendChild(audio);
                audio.play().catch(err => log('Audio failed', err));
            }

            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'video-name';
            nameDiv.textContent = name + (isLocal ? ' (You)' : '');

            const statusDiv = document.createElement('div');
            statusDiv.className = 'video-status';

            const micIcon = document.createElement('i');
            micIcon.className = hasAudio ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            if (!hasAudio) micIcon.style.color = '#EF4444';
            statusDiv.appendChild(micIcon);

            overlay.appendChild(nameDiv);
            overlay.appendChild(statusDiv);
            tile.appendChild(overlay);

            return tile;
        }

        function createParticipantTile(participant) {
            const tile = document.createElement('div');
            tile.className = 'video-tile';
            tile.id = `tile-${participant.userId}`;

            const name = participant.name || participant.userId || 'Guest';
            const initial = name.charAt(0).toUpperCase();
            const isLocal = participant.isLocalParticipant;

            const videoStream = participant.videoStream;
            const hasVideo = videoStream && 
                            videoStream.getVideoTracks().length > 0 &&
                            videoStream.getVideoTracks()[0].enabled &&
                            videoStream.getVideoTracks()[0].readyState === 'live';

            const audioStream = participant.audioStream;
            const hasAudio = audioStream && 
                            audioStream.getAudioTracks().length > 0 &&
                            audioStream.getAudioTracks()[0].enabled &&
                            audioStream.getAudioTracks()[0].readyState === 'live';

            if (hasVideo) {
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.muted = isLocal;
                video.srcObject = videoStream;
                video.id = `video-${participant.userId}`;
                
                tile.appendChild(video);

                video.onloadedmetadata = () => {
                    video.play().catch(err => {
                        log('Video play failed, retrying...', err);
                        setTimeout(() => video.play(), 500);
                    });
                };
            } else {
                const avatar = document.createElement('div');
                avatar.className = 'video-avatar';
                avatar.textContent = initial;
                tile.appendChild(avatar);
            }

            if (hasAudio && !isLocal) {
                const audio = document.createElement('audio');
                audio.autoplay = true;
                audio.srcObject = audioStream;
                audio.id = `audio-${participant.userId}`;
                
                tile.appendChild(audio);

                audio.play().catch(err => {
                    log('Audio play failed', err);
                    const retry = () => {
                        audio.play().catch(e => log('Audio retry failed', e));
                        document.removeEventListener('click', retry);
                    };
                    document.addEventListener('click', retry, { once: true });
                });
            }

            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'video-name';
            nameDiv.textContent = name + (isLocal ? ' (You)' : '');

            const statusDiv = document.createElement('div');
            statusDiv.className = 'video-status';

            const micIcon = document.createElement('i');
            micIcon.className = hasAudio ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            if (!hasAudio) micIcon.style.color = '#EF4444';
            statusDiv.appendChild(micIcon);

            if (hasVideo) {
                const vidIcon = document.createElement('i');
                vidIcon.className = 'fas fa-video';
                statusDiv.appendChild(vidIcon);
            }

            overlay.appendChild(nameDiv);
            overlay.appendChild(statusDiv);
            tile.appendChild(overlay);

            return tile;
        }

        async function toggleMute() {
            if (!call) return;

            try {
                if (isMuted) {
                    await call.microphone.enable();
                    isMuted = false;
                    document.getElementById('muteBtn').classList.remove('active');
                    document.querySelector('#muteBtn i').className = 'fas fa-microphone';
                    log('Unmuted');
                } else {
                    await call.microphone.disable();
                    isMuted = true;
                    document.getElementById('muteBtn').classList.add('active');
                    document.querySelector('#muteBtn i').className = 'fas fa-microphone-slash';
                    log('Muted');
                }

                setTimeout(() => renderAllParticipants(), 300);
            } catch (err) {
                log('Toggle mute failed', err);
            }
        }

        async function toggleVideo() {
            if (!call) return;

            try {
                if (isVideoOff) {
                    await call.camera.enable();
                    isVideoOff = false;
                    document.getElementById('videoBtn').classList.remove('active');
                    document.querySelector('#videoBtn i').className = 'fas fa-video';
                    log('Video on');
                } else {
                    await call.camera.disable();
                    isVideoOff = true;
                    document.getElementById('videoBtn').classList.add('active');
                    document.querySelector('#videoBtn i').className = 'fas fa-video-slash';
                    log('Video off');
                }

                setTimeout(() => renderAllParticipants(), 500);
            } catch (err) {
                log('Toggle video failed', err);
            }
        }

        async function toggleScreenShare() {
            if (!call || !call.screenShare) {
                showError('Screen sharing not available');
                return;
            }

            try {
                if (isScreenSharing) {
                    await call.screenShare.disable();
                    isScreenSharing = false;
                    document.getElementById('screenBtn').classList.remove('active');
                    log('Screen share stopped');
                    showSuccess('Stopped sharing screen');
                } else {
                    await call.screenShare.enable();
                    isScreenSharing = true;
                    document.getElementById('screenBtn').classList.add('active');
                    log('Screen share started');
                    showSuccess('Sharing your screen');
                }

                setTimeout(() => renderAllParticipants(), 1000);
            } catch (err) {
                log('Screen share failed', err);
                if (err.name !== 'NotAllowedError') {
                    showError('Failed to share screen');
                }
            }
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');
        }

        async function sendReaction(emoji) {
            if (!call) return;

            try {
                await call.sendCustomEvent({
                    type: 'reaction',
                    emoji: emoji
                });

                log('Sent reaction', emoji);

                const localParticipant = Array.from(call.state.participants.values())
                    .find(p => p.isLocalParticipant);
                if (localParticipant) {
                    showReaction(localParticipant.userId, emoji);
                }

                document.getElementById('emojiPicker').classList.remove('active');
            } catch (err) {
                log('Send reaction failed', err);
            }
        }

        function showReaction(userId, emoji) {
            // Find the tile - could be in grid, strip, or stage (PIP)
            let tile = document.getElementById(`tile-${userId}`) ||
                      document.getElementById(`strip-tile-${userId}`);
            
            // If user is presenting, show on the stage
            if (!tile) {
                const stage = document.getElementById('screenStage');
                if (stage.classList.contains('active')) {
                    tile = stage;
                }
            }

            if (!tile) return;

            const reaction = document.createElement('div');
            reaction.className = 'reaction-overlay';
            reaction.textContent = emoji;

            // Randomize animation type
            const animations = ['reaction-float', 'reaction-burst', 'reaction-bounce', 'reaction-spin'];
            const randomAnim = animations[Math.floor(Math.random() * animations.length)];
            reaction.classList.add(randomAnim);

            // Random position variation
            const randomX = 30 + Math.random() * 40; // 30-70%
            const randomY = 30 + Math.random() * 40; // 30-70%
            reaction.style.left = `${randomX}%`;
            reaction.style.top = `${randomY}%`;

            tile.appendChild(reaction);

            // Remove after animation
            setTimeout(() => reaction.remove(), 3000);
        }

        async function leaveMeeting() {
            log('Leaving meeting...');

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            if (call) {
                await call.leave();
            }

            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('meetingInfo').classList.remove('active');
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('status').textContent = 'Ready';

            client = null;
            call = null;
            localStream = null;

            log('‚úÖ Left meeting');
        }

        function showVideoUI(meetingId) {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('videoContainer').classList.add('active');
            document.getElementById('meetingInfo').classList.add('active');
            document.getElementById('status').textContent = 'In Meeting';

            const url = window.location.href.split('#')[0];
            const link = `${url}#meetingId=${meetingId}`;
            
            document.getElementById('displayMeetingId').textContent = meetingId;
            document.getElementById('displayLink').textContent = link;

            log('‚úÖ Video UI shown');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            if (show) {
                document.getElementById('loginBox').style.display = 'none';
            } else if (!document.getElementById('videoContainer').classList.contains('active')) {
                document.getElementById('loginBox').style.display = 'block';
            }
        }

        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = msg;
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 5000);
        }

        function showSuccess(msg) {
            const alert = document.getElementById('successAlert');
            alert.textContent = msg;
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 3000);
        }

        function copyText(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Copied!');
            });
        }

        // Auto-join from URL
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const meetingId = params.get('meetingId');
        if (meetingId) {
            document.getElementById('meetingId').value = meetingId;
            switchTab('join');
            log('Auto-filled meeting ID', meetingId);
        }

        // Close emoji picker on outside click
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('emojiPicker');
            const emojiBtn = document.getElementById('emojiBtn');
            if (!picker.contains(e.target) && !emojiBtn.contains(e.target)) {
                picker.classList.remove('active');
            }
        });

        log('‚úÖ App initialized');
    </script>
</body>
</html>
