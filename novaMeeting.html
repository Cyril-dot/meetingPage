<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova ‚Äî Meeting</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0d0f14;--surface:#151820;--s2:#1c2030;--border:#252a38;
              --accent:#4f8eff;--success:#34d399;--danger:#f87171;--text:#e8eaf0;--muted:#6b7280;--r:12px;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}
        body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
            background:radial-gradient(ellipse 60% 40% at 15% 15%,rgba(79,142,255,.06) 0%,transparent 50%),
                       radial-gradient(ellipse 40% 40% at 85% 85%,rgba(124,92,252,.05) 0%,transparent 50%);}

        .meeting-screen{display:flex;flex-direction:column;height:100vh;position:relative;z-index:1;}

        /* header */
        .header{background:var(--surface);border-bottom:1px solid var(--border);
                padding:13px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
        .header-left{display:flex;align-items:center;gap:16px;}
        .brand{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;}
        .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);
             box-shadow:0 0 10px var(--accent);animation:pulse 2.4s ease-in-out infinite;}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
        .live-badge{font-size:10px;font-weight:600;padding:3px 8px;
                    background:rgba(248,113,113,.2);border:1px solid rgba(248,113,113,.4);
                    color:#fca5a5;border-radius:20px;letter-spacing:.5px;}
        .code-badge{font-family:'DM Mono',monospace;font-size:12px;background:var(--s2);
                    border:1px solid var(--border);padding:5px 12px;border-radius:8px;
                    color:var(--accent);cursor:pointer;transition:all .2s;}
        .code-badge:hover{border-color:var(--accent);background:rgba(79,142,255,.08);}
        .pcount{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;}
        .pcount::before{content:'';width:7px;height:7px;border-radius:50%;
                        background:var(--success);box-shadow:0 0 6px var(--success);}
        .header-right{display:flex;gap:8px;}
        .icon-btn{padding:7px 14px;background:var(--s2);border:1px solid var(--border);
                  border-radius:8px;color:var(--muted);font-family:inherit;font-size:13px;
                  cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;}
        .icon-btn:hover{border-color:var(--accent);color:var(--text);}

        /* Professional grid layout - default */
        .videos{
            flex:1;
            display:grid;
            gap:12px;
            padding:14px;
            overflow-y:auto;
            align-content:start;
            transition:all .3s;
        }
        
        /* Dynamic grid based on participant count */
        .videos.count-1{grid-template-columns:1fr;}
        .videos.count-2{grid-template-columns:repeat(2,1fr);}
        .videos.count-3{grid-template-columns:repeat(2,1fr);}
        .videos.count-4{grid-template-columns:repeat(2,1fr);}
        .videos.count-5,.videos.count-6{grid-template-columns:repeat(3,1fr);}
        .videos.count-7,.videos.count-8,.videos.count-9{grid-template-columns:repeat(3,1fr);}
        .videos.count-10plus{grid-template-columns:repeat(4,1fr);}

        /* Professional screen share layout */
        .videos.presenting{
            grid-template-columns:1fr 280px;
            grid-template-rows:1fr;
            gap:14px;
            max-height:calc(100vh - 140px);
        }

        .main-stage{
            grid-column:1;
            grid-row:1;
            display:flex;
            align-items:center;
            justify-content:center;
            background:var(--surface);
            border:2px solid var(--accent);
            border-radius:16px;
            overflow:hidden;
            box-shadow:0 8px 32px rgba(79,142,255,.2);
            position:relative;
        }

        .participants-rail{
            grid-column:2;
            grid-row:1;
            display:flex;
            flex-direction:column;
            gap:10px;
            overflow-y:auto;
            padding:4px;
        }

        .participants-rail .vw{
            aspect-ratio:16/9;
            min-height:120px;
            max-height:160px;
        }

        .vw{
            position:relative;
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:16px;
            overflow:hidden;
            aspect-ratio:16/9;
            transition:all .3s;
        }
        
        .vw:hover{
            border-color:rgba(79,142,255,.5);
            transform:translateY(-2px);
        }

        video{width:100%;height:100%;object-fit:cover;}
        .voverlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.7) 0%,transparent 40%);pointer-events:none;}
        .vlabel{position:absolute;bottom:10px;left:12px;font-size:13px;font-weight:500;z-index:2;}
        .sicons{position:absolute;top:9px;right:9px;display:flex;gap:5px;z-index:2;}
        .sicon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;
               justify-content:center;font-size:12px;backdrop-filter:blur(8px);}
        .sicon.muted{background:rgba(248,113,113,.8);}
        .sicon.presenting{background:rgba(79,142,255,.9);color:#fff;animation:presentPulse 2s ease-in-out infinite;}
        
        @keyframes presentPulse{0%,100%{box-shadow:0 0 0 0 rgba(79,142,255,.7)}50%{box-shadow:0 0 0 6px rgba(79,142,255,0)}}

        /* no camera placeholder */
        .no-cam{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
                justify-content:center;gap:10px;color:var(--muted);background:var(--surface);}
        .no-cam-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c5cfc);
                       display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:600;color:#fff;}
        .no-cam-name{font-size:13px;}

        /* controls */
        .controls{background:var(--surface);border-top:1px solid var(--border);
                  padding:14px 24px;display:flex;justify-content:center;align-items:center;gap:10px;flex-shrink:0;}
        .ctrl{width:50px;height:50px;border-radius:50%;border:none;cursor:pointer;
              display:flex;align-items:center;justify-content:center;font-size:19px;
              transition:all .2s;position:relative;}
        .ctrl.on {background:var(--s2);border:1px solid var(--border);}
        .ctrl.off{background:rgba(248,113,113,.2);border:1px solid rgba(248,113,113,.4);}
        .ctrl.end{background:var(--danger);width:56px;height:56px;font-size:20px;box-shadow:0 4px 16px rgba(248,113,113,.35);}
        .ctrl:hover{transform:scale(1.08);}
        .ctrl.end:hover{background:#ef4444;}
        .ctrl .lbl{position:absolute;bottom:-19px;font-size:10px;color:var(--muted);white-space:nowrap;font-family:'DM Sans',sans-serif;}

        /* chat */
        .chat-panel{position:fixed;right:-350px;top:0;height:100vh;width:330px;background:var(--surface);
                    border-left:1px solid var(--border);transition:right .28s cubic-bezier(.4,0,.2,1);
                    display:flex;flex-direction:column;z-index:200;}
        .chat-panel.open{right:0;}
        .chat-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
        .chat-head h3{font-size:15px;font-weight:600;}
        .close-btn{width:26px;height:26px;border:none;background:var(--s2);border-radius:6px;
                   color:var(--muted);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;}
        .msgs{flex:1;padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:9px;}
        .msg{padding:9px 13px;background:var(--s2);border-radius:10px;border:1px solid var(--border);}
        .msender{font-size:11px;font-weight:600;color:var(--accent);margin-bottom:3px;}
        .mtext{font-size:14px;line-height:1.5;}
        .chat-input{padding:14px;border-top:1px solid var(--border);display:flex;gap:8px;}
        .chat-input input{flex:1;padding:9px 13px;background:var(--s2);border:1px solid var(--border);
                          border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;}
        .chat-input input:focus{outline:none;border-color:var(--accent);}
        .send-btn{padding:9px 13px;background:var(--accent);border:none;border-radius:8px;
                  color:#fff;cursor:pointer;font-size:15px;transition:background .2s;}
        .send-btn:hover{background:#3a7aee;}

        .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);
               background:var(--s2);border:1px solid var(--border);padding:9px 20px;
               border-radius:20px;font-size:13px;color:var(--success);opacity:0;transition:all .3s;z-index:1000;pointer-events:none;}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

        .hidden{display:none !important;}

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .videos.presenting{
                grid-template-columns:1fr;
                grid-template-rows:1fr auto;
            }
            .participants-rail{
                grid-column:1;
                grid-row:2;
                flex-direction:row;
                overflow-x:auto;
                padding:8px 4px;
            }
            .participants-rail .vw{
                min-width:160px;
                max-height:120px;
            }
        }

        @media (max-width: 640px) {
            .participants-rail .vw{
                min-width:140px;
                max-height:100px;
            }
            .videos.count-3,.videos.count-4{grid-template-columns:repeat(1,1fr);}
            .videos.count-5,.videos.count-6{grid-template-columns:repeat(2,1fr);}
        }
    </style>
</head>
<body>

<div class="meeting-screen">
    <div class="header">
        <div class="header-left">
            <div class="brand"><div class="dot"></div>Nova<span class="live-badge">LIVE</span></div>
            <div class="code-badge" id="codeDisplay" onclick="copyCode()" title="Click to copy">---</div>
            <div class="pcount" id="pcount">1 participant</div>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="toggleChat()">üí¨ Chat</button>
        </div>
    </div>

    <div class="videos count-1" id="videosGrid">
        <!-- Videos dynamically added here -->
    </div>

    <div class="controls">
        <div style="position:relative">
            <button class="ctrl on" id="videoBtn" onclick="toggleVideo()">üìπ</button>
            <span class="lbl">Camera</span>
        </div>
        <div style="position:relative">
            <button class="ctrl on" id="audioBtn" onclick="toggleAudio()">üé§</button>
            <span class="lbl">Mic</span>
        </div>
        <div style="position:relative">
            <button class="ctrl on" id="screenBtn" onclick="toggleScreen()">üñ•Ô∏è</button>
            <span class="lbl">Share</span>
        </div>
        <div style="position:relative">
            <button class="ctrl end" onclick="leave()">üìû</button>
            <span class="lbl">Leave</span>
        </div>
    </div>
</div>

<div id="chatPanel" class="chat-panel">
    <div class="chat-head">
        <h3>In-call messages</h3>
        <button class="close-btn" onclick="toggleChat()">‚úï</button>
    </div>
    <div class="msgs" id="msgs"></div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Send a message‚Ä¶">
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<div class="toast" id="toast">Copied!</div>

<script src="novaState.js"></script>
<script>
    const WS_URL = 'wss://poikiloblastic-leeanne-gazeless.ngrok-free.dev/ws/webrtc';
    const ICE = { iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] };

    // ‚îÄ‚îÄ Load state from NovaState ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const token       = NovaState.getToken();
    const user        = NovaState.getUser();
    const meetCode    = NovaState.getMeetingCode();
    const myName      = user?.name || 'Guest';
    const myPeerId    = 'peer_' + Math.random().toString(36).substr(2,9);

    if (!meetCode) { alert('No meeting code found. Redirecting‚Ä¶'); location.href = 'novaJoin.html'; }

    let localStream = null, screenStream = null, ws = null;
    let peers = {}, videoOn = true, audioOn = true;
    let isScreenSharing = false; // Track if I'm sharing
    let activePresenterId = null; // Track who is presenting (remote)
    let cameraStream = null; // Store original camera stream

    const initial = myName.charAt(0).toUpperCase();

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('codeDisplay').textContent = meetCode;

    (async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video:{width:1280,height:720}, audio:true });
            cameraStream = localStream; // Store reference to camera
            createLocalVideo();
        } catch (err) {
            console.warn('No camera/mic:', err.message);
            videoOn = false;
            document.getElementById('videoBtn').className = 'ctrl off';
            document.getElementById('videoBtn').textContent = 'üö´';
            createLocalVideo();
        }
        connectWS();
    })();

    // ‚îÄ‚îÄ Create local video wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function createLocalVideo() {
        const grid = document.getElementById('videosGrid');
        const wrapper = document.createElement('div');
        wrapper.className = 'vw';
        wrapper.id = 'localWrapper';
        
        const video = document.createElement('video');
        video.id = 'localVideo';
        video.autoplay = true;
        video.muted = true;
        video.playsinline = true;
        if (localStream) video.srcObject = localStream;
        
        const overlay = document.createElement('div');
        overlay.className = 'voverlay';
        
        const label = document.createElement('div');
        label.className = 'vlabel';
        label.id = 'localLabel';
        label.textContent = myName;
        
        const icons = document.createElement('div');
        icons.className = 'sicons';
        icons.id = 'localIcons';
        
        const noCam = document.createElement('div');
        noCam.className = 'no-cam' + (videoOn ? ' hidden' : '');
        noCam.id = 'noCam';
        noCam.innerHTML = `
            <div class="no-cam-avatar">${initial}</div>
            <div class="no-cam-name">${myName}</div>
        `;
        
        wrapper.append(video, overlay, label, icons, noCam);
        grid.appendChild(wrapper);
    }

    // ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function connectWS() {
        const url = token ? `${WS_URL}?token=${token}` : WS_URL;
        ws = new WebSocket(url);
        ws.onopen = () => {
            console.log('‚úÖ WS open');
            send({ type:'JOIN', meetingCode:meetCode, fromPeerId:myPeerId });
        };
        ws.onmessage = async (e) => {
            const msg = JSON.parse(e.data);
            switch(msg.type) {
                case 'PARTICIPANT_LIST': msg.data.peers.forEach(id => createPC(id, true)); break;
                case 'JOIN':            updateLayout(); break;
                case 'LEAVE':          peerLeave(msg.fromPeerId); break;
                case 'OFFER':          await handleOffer(msg); break;
                case 'ANSWER':         await handleAnswer(msg); break;
                case 'ICE_CANDIDATE':  await handleICE(msg); break;
                case 'CHAT_MESSAGE':   addMsg(msg.data.senderName, msg.data.message, false); break;
                case 'TOGGLE_VIDEO':
                case 'TOGGLE_AUDIO':   updateMuteIcon(msg); break;
                case 'SCREEN_SHARE_START': handleRemoteScreenStart(msg.fromPeerId); break;
                case 'SCREEN_SHARE_STOP':  handleRemoteScreenStop(msg.fromPeerId); break;
            }
        };
        ws.onerror = e => console.error('WS error', e);
        ws.onclose = ()  => console.log('WS closed');
    }

    function send(obj) {
        if (ws?.readyState === WebSocket.OPEN) {
            obj.meetingCode = meetCode;
            obj.fromPeerId  = myPeerId;
            ws.send(JSON.stringify(obj));
        }
    }

    // ‚îÄ‚îÄ WebRTC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function createPC(peerId, isInit) {
        const pc = new RTCPeerConnection(ICE);
        peers[peerId] = pc;
        
        // Add current stream (camera or screen)
        if (localStream) {
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        }
        
        pc.ontrack = e => addRemoteVideo(peerId, e.streams[0]);
        pc.onicecandidate = e => { 
            if(e.candidate) send({type:'ICE_CANDIDATE',toPeerId:peerId,data:e.candidate}); 
        };
        pc.onconnectionstatechange = () => { 
            if(['disconnected','failed'].includes(pc.connectionState)) peerLeave(peerId); 
        };
        
        if (isInit) {
            pc.createOffer()
                .then(o=>pc.setLocalDescription(o))
                .then(()=>send({type:'OFFER',toPeerId:peerId,data:pc.localDescription}))
                .catch(console.error);
        }
        return pc;
    }

    async function handleOffer(msg) {
        const id = msg.fromPeerId;
        if (!peers[id]) createPC(id, false);
        await peers[id].setRemoteDescription(new RTCSessionDescription(msg.data));
        const ans = await peers[id].createAnswer();
        await peers[id].setLocalDescription(ans);
        send({type:'ANSWER',toPeerId:id,data:peers[id].localDescription});
    }
    
    async function handleAnswer(msg) { 
        if(peers[msg.fromPeerId]) 
            await peers[msg.fromPeerId].setRemoteDescription(new RTCSessionDescription(msg.data)); 
    }
    
    async function handleICE(msg) { 
        if(peers[msg.fromPeerId]) 
            await peers[msg.fromPeerId].addIceCandidate(new RTCIceCandidate(msg.data)); 
    }
    
    function peerLeave(id) { 
        peers[id]?.close(); 
        delete peers[id]; 
        document.getElementById(`vw-${id}`)?.remove(); 
        if (activePresenterId === id) {
            activePresenterId = null;
        }
        updateLayout(); 
    }

    function addRemoteVideo(id, stream) {
        let wrapper = document.getElementById(`vw-${id}`);
        
        if (wrapper) { 
            const video = wrapper.querySelector('video');
            video.srcObject = stream;
            return; 
        }
        
        wrapper = document.createElement('div'); 
        wrapper.className = 'vw'; 
        wrapper.id = `vw-${id}`;
        
        const video = document.createElement('video'); 
        video.srcObject = stream; 
        video.autoplay = true; 
        video.playsinline = true;
        
        const overlay = document.createElement('div'); 
        overlay.className = 'voverlay';
        
        const label = document.createElement('div'); 
        label.className = 'vlabel'; 
        label.textContent = `Peer ${id.slice(-4)}`;
        
        const icons = document.createElement('div'); 
        icons.className = 'sicons'; 
        icons.id = `ic-${id}`;
        
        wrapper.append(video, overlay, label, icons);
        document.getElementById('videosGrid').appendChild(wrapper);
        updateLayout();
    }

    function updateMuteIcon(msg) {
        const ic = document.getElementById(`ic-${msg.fromPeerId}`);
        if(!ic) return;
        
        const eid = `${msg.type==='TOGGLE_AUDIO'?'ai':'vi'}-${msg.fromPeerId}`;
        let el = document.getElementById(eid);
        
        if (!msg.data.enabled) {
            if (!el) { 
                el = document.createElement('div'); 
                el.id = eid; 
                el.className = 'sicon muted'; 
                el.textContent = msg.type === 'TOGGLE_AUDIO' ? 'üîá' : 'üö´'; 
                ic.appendChild(el); 
            }
        } else { 
            el?.remove(); 
        }
    }

    // ‚îÄ‚îÄ Layout Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateLayout() {
        const grid = document.getElementById('videosGrid');
        const participantCount = Object.keys(peers).length + 1;
        
        // Update participant count
        document.getElementById('pcount').textContent = 
            `${participantCount} participant${participantCount !== 1 ? 's' : ''}`;
        
        // Check if anyone is presenting
        const isPresenting = isScreenSharing || activePresenterId;
        
        if (isPresenting) {
            // Presentation layout
            grid.className = 'videos presenting';
            grid.innerHTML = '';
            
            // Create main stage
            const mainStage = document.createElement('div');
            mainStage.className = 'main-stage';
            
            // Create participants rail
            const rail = document.createElement('div');
            rail.className = 'participants-rail';
            
            if (isScreenSharing) {
                // I'm presenting - show my screen in main stage
                const screenWrapper = createVideoWrapper(
                    'screenWrapper',
                    screenStream,
                    `${myName} (presenting)`,
                    true,
                    true
                );
                mainStage.appendChild(screenWrapper);
                
                // Add my camera to rail
                const cameraWrapper = createVideoWrapper(
                    'localWrapper',
                    cameraStream,
                    myName,
                    true,
                    false
                );
                rail.appendChild(cameraWrapper);
                
                // Add all peers to rail
                Object.keys(peers).forEach(peerId => {
                    const existingWrapper = document.getElementById(`vw-${peerId}`);
                    if (existingWrapper) {
                        rail.appendChild(existingWrapper);
                    }
                });
            } else if (activePresenterId) {
                // Remote peer is presenting
                const presenterWrapper = document.getElementById(`vw-${activePresenterId}`);
                if (presenterWrapper) {
                    mainStage.appendChild(presenterWrapper);
                }
                
                // Add my video to rail
                const localWrapper = document.getElementById('localWrapper');
                if (localWrapper) {
                    rail.appendChild(localWrapper);
                }
                
                // Add other peers to rail
                Object.keys(peers).forEach(peerId => {
                    if (peerId !== activePresenterId) {
                        const existingWrapper = document.getElementById(`vw-${peerId}`);
                        if (existingWrapper) {
                            rail.appendChild(existingWrapper);
                        }
                    }
                });
            }
            
            grid.appendChild(mainStage);
            grid.appendChild(rail);
        } else {
            // Regular grid layout
            let countClass = 'count-1';
            if (participantCount === 2) countClass = 'count-2';
            else if (participantCount <= 4) countClass = 'count-4';
            else if (participantCount <= 6) countClass = 'count-6';
            else if (participantCount <= 9) countClass = 'count-9';
            else countClass = 'count-10plus';
            
            grid.className = `videos ${countClass}`;
            grid.innerHTML = '';
            
            // Add local video
            const localWrapper = document.getElementById('localWrapper') || createVideoWrapper(
                'localWrapper',
                localStream,
                myName,
                true,
                false
            );
            grid.appendChild(localWrapper);
            
            // Add all peers
            Object.keys(peers).forEach(peerId => {
                const existingWrapper = document.getElementById(`vw-${peerId}`);
                if (existingWrapper) {
                    grid.appendChild(existingWrapper);
                }
            });
        }
    }

    function createVideoWrapper(id, stream, label, isLocal, isPresenting) {
        let wrapper = document.getElementById(id);
        
        if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.className = 'vw';
            wrapper.id = id;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsinline = true;
            if (isLocal) {
                video.id = id === 'localWrapper' ? 'localVideo' : 'screenVideo';
                video.muted = true;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'voverlay';
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'vlabel';
            labelDiv.textContent = label;
            
            const icons = document.createElement('div');
            icons.className = 'sicons';
            icons.id = isLocal ? 'localIcons' : `ic-${id}`;
            
            wrapper.append(video, overlay, labelDiv, icons);
            
            if (isLocal && id === 'localWrapper' && !videoOn) {
                const noCam = document.createElement('div');
                noCam.className = 'no-cam';
                noCam.id = 'noCam';
                noCam.innerHTML = `
                    <div class="no-cam-avatar">${initial}</div>
                    <div class="no-cam-name">${myName}</div>
                `;
                wrapper.appendChild(noCam);
            }
        }
        
        const video = wrapper.querySelector('video');
        if (stream) video.srcObject = stream;
        
        const labelDiv = wrapper.querySelector('.vlabel');
        labelDiv.textContent = label;
        
        // Handle presenting icon
        const icons = wrapper.querySelector('.sicons');
        const existingPresentIcon = icons.querySelector('.presenting');
        
        if (isPresenting && !existingPresentIcon) {
            const presentIcon = document.createElement('div');
            presentIcon.className = 'sicon presenting';
            presentIcon.textContent = 'üñ•Ô∏è';
            presentIcon.id = 'present-icon';
            icons.appendChild(presentIcon);
        } else if (!isPresenting && existingPresentIcon) {
            existingPresentIcon.remove();
        }
        
        return wrapper;
    }

    function handleRemoteScreenStart(peerId) {
        activePresenterId = peerId;
        
        // Add presenting icon to the peer
        const icons = document.getElementById(`ic-${peerId}`);
        if (icons && !icons.querySelector('.presenting')) {
            const presentIcon = document.createElement('div');
            presentIcon.id = `present-${peerId}`;
            presentIcon.className = 'sicon presenting';
            presentIcon.textContent = 'üñ•Ô∏è';
            icons.appendChild(presentIcon);
        }
        
        updateLayout();
    }

    function handleRemoteScreenStop(peerId) {
        if (activePresenterId === peerId) {
            activePresenterId = null;
        }
        
        // Remove presenting icon
        document.getElementById(`present-${peerId}`)?.remove();
        
        updateLayout();
    }

    // ‚îÄ‚îÄ Media controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleVideo() {
        if (!cameraStream) return;
        
        videoOn = !videoOn;
        cameraStream.getVideoTracks().forEach(t => t.enabled = videoOn);
        
        document.getElementById('videoBtn').className = `ctrl ${videoOn?'on':'off'}`;
        document.getElementById('videoBtn').textContent = videoOn ? 'üìπ' : 'üö´';
        
        const noCam = document.getElementById('noCam');
        if (noCam) {
            noCam.classList.toggle('hidden', videoOn);
        }
        
        send({type:'TOGGLE_VIDEO', data:{enabled:videoOn}});
    }

    function toggleAudio() {
        if (!localStream && !cameraStream) return;
        
        audioOn = !audioOn;
        const stream = localStream || cameraStream;
        stream.getAudioTracks().forEach(t => t.enabled = audioOn);
        
        document.getElementById('audioBtn').className = `ctrl ${audioOn?'on':'off'}`;
        document.getElementById('audioBtn').textContent = audioOn ? 'üé§' : 'üîá';
        
        send({type:'TOGGLE_AUDIO', data:{enabled:audioOn}});
    }

    async function toggleScreen() {
        if (isScreenSharing) {
            // Stop screen sharing
            screenStream.getTracks().forEach(t => t.stop());
            screenStream = null;
            isScreenSharing = false;
            
            // Switch back to camera stream
            localStream = cameraStream;
            
            // Update button
            document.getElementById('screenBtn').className = 'ctrl on';
            
            // Replace screen track with camera track for all peers
            const videoTrack = cameraStream.getVideoTracks()[0];
            Object.values(peers).forEach(pc => { 
                const sender = pc.getSenders().find(s => s.track?.kind === 'video'); 
                if (sender && videoTrack) {
                    sender.replaceTrack(videoTrack);
                }
            });
            
            // Update local video to show camera
            const localVideo = document.getElementById('localVideo');
            if (localVideo) {
                localVideo.srcObject = cameraStream;
            }
            
            send({type:'SCREEN_SHARE_STOP'});
            updateLayout();
        } else {
            // Start screen sharing
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                isScreenSharing = true;
                
                // Update button
                document.getElementById('screenBtn').className = 'ctrl off';
                
                const screenTrack = screenStream.getVideoTracks()[0];
                
                // Replace camera track with screen track for all peers
                Object.values(peers).forEach(pc => { 
                    const sender = pc.getSenders().find(s => s.track?.kind === 'video'); 
                    if (sender) {
                        sender.replaceTrack(screenTrack);
                    }
                });
                
                // Handle screen share stop (user clicks browser stop button)
                screenTrack.onended = () => {
                    if (isScreenSharing) {
                        toggleScreen();
                    }
                };
                
                send({type:'SCREEN_SHARE_START'});
                updateLayout();
            } catch(e) { 
                console.error('Screen share error:', e);
                showToast('Screen sharing cancelled');
            }
        }
    }

    // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleChat() { 
        document.getElementById('chatPanel').classList.toggle('open'); 
    }

    function sendMsg() {
        const inp = document.getElementById('chatInput');
        const txt = inp.value.trim(); 
        if (!txt) return;
        
        addMsg(myName, txt, true);
        send({type:'CHAT_MESSAGE', data:{message:txt, senderName:myName, timestamp:Date.now()}});
        inp.value = '';
    }

    function addMsg(sender, text, isSelf) {
        const div = document.createElement('div'); 
        div.className = 'msg';
        
        const s = document.createElement('div'); 
        s.className = 'msender'; 
        s.textContent = isSelf ? `${sender} (you)` : sender;
        
        const t = document.createElement('div'); 
        t.className = 'mtext';   
        t.textContent = text;
        
        div.append(s, t);
        
        const box = document.getElementById('msgs');
        box.appendChild(div); 
        box.scrollTop = box.scrollHeight;
    }

    // ‚îÄ‚îÄ Copy code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function copyCode() {
        navigator.clipboard.writeText(meetCode).then(() => {
            showToast('Code copied!');
        });
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2200);
    }

    // ‚îÄ‚îÄ Leave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function leave() {
        if (!confirm('Leave this meeting?')) return;
        
        localStream?.getTracks().forEach(t => t.stop());
        screenStream?.getTracks().forEach(t => t.stop());
        cameraStream?.getTracks().forEach(t => t.stop());
        
        Object.values(peers).forEach(pc => pc.close()); 
        peers = {};
        
        if (ws) { 
            send({type:'LEAVE'}); 
            ws.close(); 
        }
        
        localStream = null; 
        screenStream = null; 
        cameraStream = null;
        ws = null;
        
        NovaState.clearMeetingCode();
        location.href = NovaState.isLoggedIn() ? 'novaDash.html' : 'novaJoin.html';
    }

    // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT') return; // Don't trigger when typing in chat
        if (e.key === 'd') toggleVideo();
        if (e.key === 'a') toggleAudio();
        if (e.key === 's') toggleScreen();
    });
    
    document.getElementById('chatInput').addEventListener('keypress', e => { 
        if (e.key === 'Enter') sendMsg(); 
    });
</script>
</body>
</html>
