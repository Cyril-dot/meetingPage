<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova ‚Äî Meeting</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0d0f14;--surface:#151820;--s2:#1c2030;--border:#252a38;
              --accent:#4f8eff;--success:#34d399;--danger:#f87171;--text:#e8eaf0;--muted:#6b7280;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
        body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
            background:radial-gradient(ellipse 60% 40% at 15% 15%,rgba(79,142,255,.06) 0%,transparent 50%),
                       radial-gradient(ellipse 40% 40% at 85% 85%,rgba(124,92,252,.05) 0%,transparent 50%);}

        .meeting-screen{display:flex;flex-direction:column;height:100vh;position:relative;z-index:1;}

        /* header */
        .header{background:var(--surface);border-bottom:1px solid var(--border);
                padding:13px 24px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
        .header-left{display:flex;align-items:center;gap:16px;}
        .brand{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;}
        .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);
             box-shadow:0 0 10px var(--accent);animation:pulse 2.4s ease-in-out infinite;}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
        .live-badge{font-size:10px;font-weight:600;padding:3px 8px;
                    background:rgba(248,113,113,.2);border:1px solid rgba(248,113,113,.4);
                    color:#fca5a5;border-radius:20px;letter-spacing:.5px;}
        .code-badge{font-family:'DM Mono',monospace;font-size:12px;background:var(--s2);
                    border:1px solid var(--border);padding:5px 12px;border-radius:8px;
                    color:var(--accent);cursor:pointer;transition:all .2s;}
        .code-badge:hover{border-color:var(--accent);background:rgba(79,142,255,.08);}
        .pcount{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;}
        .pcount::before{content:'';width:7px;height:7px;border-radius:50%;
                        background:var(--success);box-shadow:0 0 6px var(--success);}
        .header-right{display:flex;gap:8px;}
        .icon-btn{padding:7px 14px;background:var(--s2);border:1px solid var(--border);
                  border-radius:8px;color:var(--muted);font-family:inherit;font-size:13px;
                  cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;}
        .icon-btn:hover{border-color:var(--accent);color:var(--text);}

        /* Professional grid layout */
        .videos{flex:1;display:grid;gap:12px;padding:14px;overflow-y:auto;align-content:start;}
        .videos.count-1{grid-template-columns:1fr;}
        .videos.count-2{grid-template-columns:repeat(2,1fr);}
        .videos.count-3,.videos.count-4{grid-template-columns:repeat(2,1fr);}
        .videos.count-5,.videos.count-6{grid-template-columns:repeat(3,1fr);}
        .videos.count-7,.videos.count-8,.videos.count-9{grid-template-columns:repeat(3,1fr);}
        .videos.count-10plus{grid-template-columns:repeat(4,1fr);}

        /* Screen share layout */
        .videos.presenting{grid-template-columns:1fr 300px;grid-template-rows:1fr;gap:14px;}
        .main-stage{grid-column:1;display:flex;align-items:center;justify-content:center;
                   background:var(--surface);border:2px solid var(--accent);border-radius:16px;
                   overflow:hidden;box-shadow:0 8px 32px rgba(79,142,255,.2);}
        .participants-rail{grid-column:2;display:flex;flex-direction:column;gap:10px;overflow-y:auto;padding:4px;}
        .participants-rail .vw{aspect-ratio:16/9;min-height:120px;max-height:160px;}

        .vw{position:relative;background:var(--surface);border:1px solid var(--border);
            border-radius:16px;overflow:hidden;aspect-ratio:16/9;}
        .vw:hover{border-color:rgba(79,142,255,.5);transform:translateY(-2px);}
        video{width:100%;height:100%;object-fit:cover;}
        .voverlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.7) 0%,transparent 40%);pointer-events:none;}
        .vlabel{position:absolute;bottom:10px;left:12px;font-size:13px;font-weight:500;z-index:2;color:#fff;}
        .sicons{position:absolute;top:9px;right:9px;display:flex;gap:5px;z-index:2;}
        .sicon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;
               justify-content:center;font-size:12px;backdrop-filter:blur(8px);}
        .sicon.muted{background:rgba(248,113,113,.8);color:#fff;}
        .sicon.presenting{background:rgba(79,142,255,.9);color:#fff;animation:presentPulse 2s ease-in-out infinite;}
        @keyframes presentPulse{0%,100%{box-shadow:0 0 0 0 rgba(79,142,255,.7)}50%{box-shadow:0 0 0 6px rgba(79,142,255,0)}}

        .no-cam{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
                justify-content:center;gap:10px;color:var(--muted);background:var(--s2);}
        .no-cam-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#7c5cfc);
                       display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:600;color:#fff;}
        .no-cam-name{font-size:13px;}

        /* controls */
        .controls{background:var(--surface);border-top:1px solid var(--border);
                  padding:14px 24px;display:flex;justify-content:center;align-items:center;gap:10px;flex-shrink:0;}
        .ctrl{width:50px;height:50px;border-radius:50%;border:none;cursor:pointer;
              display:flex;align-items:center;justify-content:center;font-size:19px;transition:all .2s;position:relative;}
        .ctrl.on{background:var(--s2);border:1px solid var(--border);}
        .ctrl.off{background:rgba(248,113,113,.2);border:1px solid rgba(248,113,113,.4);}
        .ctrl.end{background:var(--danger);width:56px;height:56px;font-size:20px;box-shadow:0 4px 16px rgba(248,113,113,.35);}
        .ctrl:hover{transform:scale(1.08);}
        .ctrl.end:hover{background:#ef4444;}
        .ctrl .lbl{position:absolute;bottom:-19px;font-size:10px;color:var(--muted);white-space:nowrap;}

        /* chat */
        .chat-panel{position:fixed;right:-350px;top:0;height:100vh;width:330px;background:var(--surface);
                    border-left:1px solid var(--border);transition:right .28s;display:flex;flex-direction:column;z-index:200;}
        .chat-panel.open{right:0;}
        .chat-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
        .chat-head h3{font-size:15px;font-weight:600;}
        .close-btn{width:26px;height:26px;border:none;background:var(--s2);border-radius:6px;
                   color:var(--muted);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;}
        .msgs{flex:1;padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:9px;}
        .msg{padding:9px 13px;background:var(--s2);border-radius:10px;border:1px solid var(--border);}
        .msender{font-size:11px;font-weight:600;color:var(--accent);margin-bottom:3px;}
        .mtext{font-size:14px;line-height:1.5;}
        .chat-input{padding:14px;border-top:1px solid var(--border);display:flex;gap:8px;}
        .chat-input input{flex:1;padding:9px 13px;background:var(--s2);border:1px solid var(--border);
                          border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;}
        .chat-input input:focus{outline:none;border-color:var(--accent);}
        .send-btn{padding:9px 13px;background:var(--accent);border:none;border-radius:8px;
                  color:#fff;cursor:pointer;font-size:15px;}
        .send-btn:hover{background:#3a7aee;}

        .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);
               background:var(--s2);border:1px solid var(--border);padding:9px 20px;border-radius:20px;
               font-size:13px;color:var(--success);opacity:0;transition:all .3s;z-index:1000;pointer-events:none;}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
        .hidden{display:none !important;}

        @media (max-width: 1024px) {
            .videos.presenting{grid-template-columns:1fr;grid-template-rows:1fr auto;}
            .participants-rail{grid-column:1;grid-row:2;flex-direction:row;overflow-x:auto;padding:8px 4px;}
            .participants-rail .vw{min-width:160px;max-height:120px;}
        }
    </style>
</head>
<body>

<div class="meeting-screen">
    <div class="header">
        <div class="header-left">
            <div class="brand"><div class="dot"></div>Nova<span class="live-badge">LIVE</span></div>
            <div class="code-badge" id="codeDisplay" onclick="copyCode()">---</div>
            <div class="pcount" id="pcount">1 participant</div>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="toggleChat()">üí¨ Chat</button>
        </div>
    </div>

    <div class="videos count-1" id="videosGrid"></div>

    <div class="controls">
        <div style="position:relative">
            <button class="ctrl on" id="videoBtn" onclick="toggleVideo()">üìπ</button>
            <span class="lbl">Camera</span>
        </div>
        <div style="position:relative">
            <button class="ctrl on" id="audioBtn" onclick="toggleAudio()">üé§</button>
            <span class="lbl">Mic</span>
        </div>
        <div style="position:relative">
            <button class="ctrl on" id="screenBtn" onclick="toggleScreen()">üñ•Ô∏è</button>
            <span class="lbl">Share</span>
        </div>
        <div style="position:relative">
            <button class="ctrl end" onclick="leave()">üìû</button>
            <span class="lbl">Leave</span>
        </div>
    </div>
</div>

<div id="chatPanel" class="chat-panel">
    <div class="chat-head">
        <h3>In-call messages</h3>
        <button class="close-btn" onclick="toggleChat()">‚úï</button>
    </div>
    <div class="msgs" id="msgs"></div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Send a message‚Ä¶">
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="novaState.js"></script>
<script>
    const WS_URL = 'wss://poikiloblastic-leeanne-gazeless.ngrok-free.dev/ws/webrtc';
    const ICE = { iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] };

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const token = NovaState.getToken();
    const user = NovaState.getUser();
    const meetCode = NovaState.getMeetingCode();
    const myName = user?.name || 'Guest';
    const myPeerId = 'peer_' + Math.random().toString(36).substr(2,9);
    const initial = myName.charAt(0).toUpperCase();

    if (!meetCode) { alert('No meeting code'); location.href = 'novaJoin.html'; }

    let ws = null;
    let localCameraStream = null;  // Original camera+audio stream
    let screenStream = null;        // Screen share stream
    let peers = {};                 // { peerId: RTCPeerConnection }
    let peerStreams = {};          // { peerId: MediaStream }
    let videoOn = true, audioOn = true;
    let isScreenSharing = false;
    let remotePresenterId = null;  // Who is presenting remotely

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('codeDisplay').textContent = meetCode;

    (async () => {
        try {
            localCameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 1280, height: 720 }, 
                audio: { echoCancellation: true, noiseSuppression: true } 
            });
            console.log('‚úÖ Got local camera stream:', localCameraStream.id);
        } catch (err) {
            console.warn('‚ö†Ô∏è No camera/mic:', err.message);
            videoOn = false;
            document.getElementById('videoBtn').className = 'ctrl off';
            document.getElementById('videoBtn').textContent = 'üö´';
        }
        renderLayout();
        connectWS();
    })();

    // ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function connectWS() {
        const url = token ? `${WS_URL}?token=${token}` : WS_URL;
        ws = new WebSocket(url);
        
        ws.onopen = () => {
            console.log('‚úÖ WebSocket connected');
            send({ type: 'JOIN', meetingCode: meetCode, fromPeerId: myPeerId });
        };
        
        ws.onmessage = async (e) => {
            const msg = JSON.parse(e.data);
            console.log('üì© Received:', msg.type, 'from', msg.fromPeerId);
            
            switch(msg.type) {
                case 'PARTICIPANT_LIST':
                    console.log('üë• Existing peers:', msg.data.peers);
                    msg.data.peers.forEach(peerId => {
                        if (peerId !== myPeerId) {
                            console.log('ü§ù Creating offer for peer:', peerId);
                            createPeerConnection(peerId, true);
                        }
                    });
                    break;
                    
                case 'JOIN':
                    console.log('üëã New peer joined:', msg.fromPeerId);
                    renderLayout();
                    break;
                    
                case 'LEAVE':
                    console.log('üëã Peer left:', msg.fromPeerId);
                    handlePeerLeave(msg.fromPeerId);
                    break;
                    
                case 'OFFER':
                    console.log('üìû Received OFFER from:', msg.fromPeerId);
                    await handleOffer(msg);
                    break;
                    
                case 'ANSWER':
                    console.log('‚úÖ Received ANSWER from:', msg.fromPeerId);
                    await handleAnswer(msg);
                    break;
                    
                case 'ICE_CANDIDATE':
                    await handleICE(msg);
                    break;
                    
                case 'CHAT_MESSAGE':
                    addMsg(msg.data.senderName, msg.data.message, false);
                    break;
                    
                case 'TOGGLE_VIDEO':
                case 'TOGGLE_AUDIO':
                    updatePeerMuteIcon(msg);
                    break;
                    
                case 'SCREEN_SHARE_START':
                    console.log('üñ•Ô∏è Peer started screen share:', msg.fromPeerId);
                    remotePresenterId = msg.fromPeerId;
                    renderLayout();
                    break;
                    
                case 'SCREEN_SHARE_STOP':
                    console.log('üñ•Ô∏è Peer stopped screen share:', msg.fromPeerId);
                    if (remotePresenterId === msg.fromPeerId) {
                        remotePresenterId = null;
                    }
                    renderLayout();
                    break;
            }
        };
        
        ws.onerror = (e) => console.error('‚ùå WebSocket error:', e);
        ws.onclose = () => console.log('üîå WebSocket closed');
    }

    function send(obj) {
        if (ws?.readyState === WebSocket.OPEN) {
            obj.meetingCode = meetCode;
            obj.fromPeerId = myPeerId;
            ws.send(JSON.stringify(obj));
        }
    }

    // ‚îÄ‚îÄ WebRTC Peer Connections ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function createPeerConnection(peerId, shouldCreateOffer) {
        console.log(`üîó Creating peer connection for: ${peerId} (offer: ${shouldCreateOffer})`);
        
        const pc = new RTCPeerConnection(ICE);
        peers[peerId] = pc;

        // Add my current stream (camera or screen)
        const currentStream = isScreenSharing ? screenStream : localCameraStream;
        if (currentStream) {
            currentStream.getTracks().forEach(track => {
                console.log(`‚ûï Adding ${track.kind} track to peer:`, peerId);
                pc.addTrack(track, currentStream);
            });
        }

        // Handle incoming tracks from remote peer
        pc.ontrack = (event) => {
            console.log(`üé• Received ${event.track.kind} track from:`, peerId, 'stream:', event.streams[0].id);
            
            const remoteStream = event.streams[0];
            peerStreams[peerId] = remoteStream;
            
            // Add remote video immediately
            addOrUpdateRemoteVideo(peerId, remoteStream);
        };

        // Send ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                send({ 
                    type: 'ICE_CANDIDATE', 
                    toPeerId: peerId, 
                    data: event.candidate 
                });
            }
        };

        // Monitor connection state
        pc.onconnectionstatechange = () => {
            console.log(`üîå Connection state for ${peerId}:`, pc.connectionState);
            if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                handlePeerLeave(peerId);
            }
        };

        pc.oniceconnectionstatechange = () => {
            console.log(`üßä ICE connection state for ${peerId}:`, pc.iceConnectionState);
        };

        // Create offer if this is the initiator
        if (shouldCreateOffer) {
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    console.log('üì§ Sending OFFER to:', peerId);
                    send({ 
                        type: 'OFFER', 
                        toPeerId: peerId, 
                        data: pc.localDescription 
                    });
                })
                .catch(err => console.error('‚ùå Error creating offer:', err));
        }

        return pc;
    }

    async function handleOffer(msg) {
        const peerId = msg.fromPeerId;
        
        // Create peer connection if it doesn't exist
        if (!peers[peerId]) {
            createPeerConnection(peerId, false);
        }

        const pc = peers[peerId];
        
        try {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            console.log('üì§ Sending ANSWER to:', peerId);
            send({ 
                type: 'ANSWER', 
                toPeerId: peerId, 
                data: pc.localDescription 
            });
        } catch (err) {
            console.error('‚ùå Error handling offer:', err);
        }
    }

    async function handleAnswer(msg) {
        const peerId = msg.fromPeerId;
        const pc = peers[peerId];
        
        if (pc) {
            try {
                await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
                console.log('‚úÖ Set remote description for:', peerId);
            } catch (err) {
                console.error('‚ùå Error setting remote description:', err);
            }
        }
    }

    async function handleICE(msg) {
        const peerId = msg.fromPeerId;
        const pc = peers[peerId];
        
        if (pc) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(msg.data));
            } catch (err) {
                console.error('‚ùå Error adding ICE candidate:', err);
            }
        }
    }

    function handlePeerLeave(peerId) {
        console.log('üëã Cleaning up peer:', peerId);
        
        if (peers[peerId]) {
            peers[peerId].close();
            delete peers[peerId];
        }
        
        delete peerStreams[peerId];
        
        const elem = document.getElementById(`vw-${peerId}`);
        if (elem) elem.remove();
        
        if (remotePresenterId === peerId) {
            remotePresenterId = null;
        }
        
        renderLayout();
    }

    function addOrUpdateRemoteVideo(peerId, stream) {
        let wrapper = document.getElementById(`vw-${peerId}`);
        
        if (wrapper) {
            // Update existing video
            const video = wrapper.querySelector('video');
            if (video.srcObject !== stream) {
                console.log('üîÑ Updating video stream for:', peerId);
                video.srcObject = stream;
            }
            return;
        }
        
        // Create new video wrapper
        console.log('üÜï Creating video element for:', peerId);
        wrapper = document.createElement('div');
        wrapper.className = 'vw';
        wrapper.id = `vw-${peerId}`;
        
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsinline = true;
        video.onloadedmetadata = () => {
            console.log('‚úÖ Video metadata loaded for:', peerId);
        };
        
        const overlay = document.createElement('div');
        overlay.className = 'voverlay';
        
        const label = document.createElement('div');
        label.className = 'vlabel';
        label.textContent = `Peer ${peerId.slice(-4)}`;
        
        const icons = document.createElement('div');
        icons.className = 'sicons';
        icons.id = `ic-${peerId}`;
        
        wrapper.append(video, overlay, label, icons);
        
        // Add to appropriate container
        const grid = document.getElementById('videosGrid');
        const rail = document.querySelector('.participants-rail');
        
        if (rail) {
            rail.appendChild(wrapper);
        } else {
            grid.appendChild(wrapper);
        }
        
        renderLayout();
    }

    function updatePeerMuteIcon(msg) {
        const icons = document.getElementById(`ic-${msg.fromPeerId}`);
        if (!icons) return;
        
        const iconId = `${msg.type === 'TOGGLE_AUDIO' ? 'ai' : 'vi'}-${msg.fromPeerId}`;
        let icon = document.getElementById(iconId);
        
        if (!msg.data.enabled) {
            if (!icon) {
                icon = document.createElement('div');
                icon.id = iconId;
                icon.className = 'sicon muted';
                icon.textContent = msg.type === 'TOGGLE_AUDIO' ? 'üîá' : 'üö´';
                icons.appendChild(icon);
            }
        } else {
            icon?.remove();
        }
    }

    // ‚îÄ‚îÄ Layout Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderLayout() {
        const grid = document.getElementById('videosGrid');
        const peerCount = Object.keys(peers).length;
        const totalParticipants = peerCount + 1;
        
        console.log(`üé® Rendering layout: ${totalParticipants} participants, presenting: ${isScreenSharing || remotePresenterId}`);
        
        // Update participant count
        document.getElementById('pcount').textContent = 
            `${totalParticipants} participant${totalParticipants !== 1 ? 's' : ''}`;
        
        const isPresenting = isScreenSharing || remotePresenterId;
        
        if (isPresenting) {
            // Presentation mode
            grid.className = 'videos presenting';
            grid.innerHTML = '';
            
            const mainStage = document.createElement('div');
            mainStage.className = 'main-stage';
            
            const rail = document.createElement('div');
            rail.className = 'participants-rail';
            
            if (isScreenSharing) {
                // I'm presenting
                const screenWrapper = createVideoElement('screen-wrapper', screenStream, `${myName} (presenting)`, true);
                mainStage.appendChild(screenWrapper);
                
                // Add my camera to rail
                const cameraWrapper = createVideoElement('local-camera', localCameraStream, myName, false);
                rail.appendChild(cameraWrapper);
                
                // Add peers to rail
                Object.keys(peers).forEach(peerId => {
                    if (peerStreams[peerId]) {
                        const peerWrapper = createVideoElement(`vw-${peerId}`, peerStreams[peerId], `Peer ${peerId.slice(-4)}`, false);
                        rail.appendChild(peerWrapper);
                    }
                });
            } else if (remotePresenterId) {
                // Remote peer is presenting
                if (peerStreams[remotePresenterId]) {
                    const presenterWrapper = createVideoElement(`vw-${remotePresenterId}`, peerStreams[remotePresenterId], `Peer ${remotePresenterId.slice(-4)} (presenting)`, true);
                    mainStage.appendChild(presenterWrapper);
                }
                
                // Add my video to rail
                const localWrapper = createVideoElement('local-wrapper', localCameraStream, myName, false);
                rail.appendChild(localWrapper);
                
                // Add other peers to rail
                Object.keys(peers).forEach(peerId => {
                    if (peerId !== remotePresenterId && peerStreams[peerId]) {
                        const peerWrapper = createVideoElement(`vw-${peerId}`, peerStreams[peerId], `Peer ${peerId.slice(-4)}`, false);
                        rail.appendChild(peerWrapper);
                    }
                });
            }
            
            grid.appendChild(mainStage);
            grid.appendChild(rail);
        } else {
            // Regular grid mode
            let countClass = 'count-1';
            if (totalParticipants === 2) countClass = 'count-2';
            else if (totalParticipants <= 4) countClass = 'count-4';
            else if (totalParticipants <= 6) countClass = 'count-6';
            else if (totalParticipants <= 9) countClass = 'count-9';
            else countClass = 'count-10plus';
            
            grid.className = `videos ${countClass}`;
            grid.innerHTML = '';
            
            // Add local video
            const localWrapper = createVideoElement('local-wrapper', localCameraStream, myName, false);
            grid.appendChild(localWrapper);
            
            // Add all peers
            Object.keys(peers).forEach(peerId => {
                if (peerStreams[peerId]) {
                    const peerWrapper = createVideoElement(`vw-${peerId}`, peerStreams[peerId], `Peer ${peerId.slice(-4)}`, false);
                    grid.appendChild(peerWrapper);
                }
            });
        }
    }

    function createVideoElement(id, stream, label, isPresenting) {
        const wrapper = document.createElement('div');
        wrapper.className = 'vw';
        wrapper.id = id;
        
        if (stream) {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;
            video.muted = id.includes('local') || id.includes('camera') || id === 'screen-wrapper';
            wrapper.appendChild(video);
        } else {
            // No camera placeholder
            const noCam = document.createElement('div');
            noCam.className = 'no-cam';
            noCam.innerHTML = `
                <div class="no-cam-avatar">${initial}</div>
                <div class="no-cam-name">${myName}</div>
            `;
            wrapper.appendChild(noCam);
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'voverlay';
        wrapper.appendChild(overlay);
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'vlabel';
        labelDiv.textContent = label;
        wrapper.appendChild(labelDiv);
        
        const icons = document.createElement('div');
        icons.className = 'sicons';
        icons.id = id.includes('local') || id === 'screen-wrapper' ? 'local-icons' : `ic-${id.replace('vw-', '')}`;
        
        if (isPresenting) {
            const presentIcon = document.createElement('div');
            presentIcon.className = 'sicon presenting';
            presentIcon.textContent = 'üñ•Ô∏è';
            icons.appendChild(presentIcon);
        }
        
        wrapper.appendChild(icons);
        
        return wrapper;
    }

    // ‚îÄ‚îÄ Media Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleVideo() {
        if (!localCameraStream) return;
        
        videoOn = !videoOn;
        localCameraStream.getVideoTracks().forEach(t => t.enabled = videoOn);
        
        document.getElementById('videoBtn').className = `ctrl ${videoOn ? 'on' : 'off'}`;
        document.getElementById('videoBtn').textContent = videoOn ? 'üìπ' : 'üö´';
        
        send({ type: 'TOGGLE_VIDEO', data: { enabled: videoOn } });
        renderLayout();
    }

    function toggleAudio() {
        if (!localCameraStream) return;
        
        audioOn = !audioOn;
        localCameraStream.getAudioTracks().forEach(t => t.enabled = audioOn);
        
        document.getElementById('audioBtn').className = `ctrl ${audioOn ? 'on' : 'off'}`;
        document.getElementById('audioBtn').textContent = audioOn ? 'üé§' : 'üîá';
        
        send({ type: 'TOGGLE_AUDIO', data: { enabled: audioOn } });
    }

    async function toggleScreen() {
        if (isScreenSharing) {
            // Stop screen sharing
            console.log('üõë Stopping screen share');
            
            screenStream.getTracks().forEach(t => t.stop());
            screenStream = null;
            isScreenSharing = false;
            
            document.getElementById('screenBtn').className = 'ctrl on';
            
            // Replace screen track with camera track for all peers
            const videoTrack = localCameraStream?.getVideoTracks()[0];
            Object.values(peers).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                if (sender && videoTrack) {
                    console.log('üîÑ Replacing screen track with camera track');
                    sender.replaceTrack(videoTrack);
                }
            });
            
            send({ type: 'SCREEN_SHARE_STOP' });
            renderLayout();
        } else {
            // Start screen sharing
            try {
                console.log('üñ•Ô∏è Starting screen share');
                
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                
                isScreenSharing = true;
                document.getElementById('screenBtn').className = 'ctrl off';
                
                const screenTrack = screenStream.getVideoTracks()[0];
                
                // Replace camera track with screen track for all peers
                Object.values(peers).forEach(pc => {
                    const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                    if (sender) {
                        console.log('üîÑ Replacing camera track with screen track');
                        sender.replaceTrack(screenTrack);
                    }
                });
                
                // Handle screen share stop (browser button)
                screenTrack.onended = () => {
                    console.log('üõë Screen share ended by user');
                    if (isScreenSharing) toggleScreen();
                };
                
                send({ type: 'SCREEN_SHARE_START' });
                renderLayout();
                
            } catch (err) {
                console.error('‚ùå Screen share error:', err);
                showToast('Screen sharing cancelled');
            }
        }
    }

    // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleChat() {
        document.getElementById('chatPanel').classList.toggle('open');
    }

    function sendMsg() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        
        addMsg(myName, text, true);
        send({ type: 'CHAT_MESSAGE', data: { message: text, senderName: myName } });
        input.value = '';
    }

    function addMsg(sender, text, isSelf) {
        const msg = document.createElement('div');
        msg.className = 'msg';
        
        const senderDiv = document.createElement('div');
        senderDiv.className = 'msender';
        senderDiv.textContent = isSelf ? `${sender} (you)` : sender;
        
        const textDiv = document.createElement('div');
        textDiv.className = 'mtext';
        textDiv.textContent = text;
        
        msg.append(senderDiv, textDiv);
        
        const box = document.getElementById('msgs');
        box.appendChild(msg);
        box.scrollTop = box.scrollHeight;
    }

    // ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function copyCode() {
        navigator.clipboard.writeText(meetCode).then(() => {
            showToast('Code copied!');
        });
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2200);
    }

    function leave() {
        if (!confirm('Leave this meeting?')) return;
        
        localCameraStream?.getTracks().forEach(t => t.stop());
        screenStream?.getTracks().forEach(t => t.stop());
        Object.values(peers).forEach(pc => pc.close());
        
        if (ws) {
            send({ type: 'LEAVE' });
            ws.close();
        }
        
        NovaState.clearMeetingCode();
        location.href = NovaState.isLoggedIn() ? 'novaDash.html' : 'novaJoin.html';
    }

    // ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.key === 'd') toggleVideo();
        if (e.key === 'a') toggleAudio();
        if (e.key === 's') toggleScreen();
    });

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMsg();
    });
</script>
</body>
</html>
